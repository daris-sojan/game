var cols,rows,canvas,canvasPosX,canvasPosY,current,imgSit,track,audioContext,panner,originalPos,pannerAmbient,ambientCurrPos,ambientOriginalPos,w=280,canvasSize=560,counter=1,grid=[],stack=[],currCellLoc=0,randRow=0,lastCol=0,level=1,profIdx=0,synth=window.speechSynthesis,isMobile=detectMobileBrowser(),successSound=document.querySelector("#success"),failSound=document.querySelector("#fail"),mobileFailSound=document.querySelector("#fail"),nextLevelSound=document.querySelector("#nextlevel"),ambientSound=document.querySelector("#ambient"),lineWeight=6,imgs=[];function preload(){imgs.push(loadImage("undefined"!=typeof stickmanPath?stickmanPath:"static/imgs/stickman.png")),imgSit=loadImage("undefined"!=typeof goalPath?goalPath:"static/imgs/goal.png")}function setup(){}function nextLevel(){counter%3==0&&0!=counter?(w/=2,level++,console.log("Level: "+level),counter=1):counter++,console.log("Counter = "+counter)}function previousLevel(){level>1&&(w*=2,level-=1,counter=1),createNewMaze()}function playAgain(){var e=document.getElementById("play-again");w*=Math.pow(2,level-1),level=1,counter=1,createNewMaze(),e.style.visibility="hidden"}function windowResized(){!checkCanvasScreenSize()&&canPlay()&&loaded&&(resizeCanvas(canvasSize,canvasSize),canvas.position(canvasPosX,canvasPosY),createNewMaze())}function createNewMaze(){document.activeElement!=document.body&&document.activeElement.blur(),document.getElementById("play-again").style.visibility="hidden",clear(),grid=[],stack=[],currCellLoc=0,cols=floor(width/w),rows=floor(height/w),randRow=randomNumber(0,rows-1);for(var e=0;e<rows;e++)for(var n=0;n<cols;n++){var o=new Cell(n,e);grid.push(o)}for(current=grid[currCellLoc];;){for(n=0;n<grid.length;n++)grid[n].show();current.visited=!0;var t=current.checkNeighbors();if(t?(t.visited=!0,stack.push(current),removeWalls(current,t),current=t):stack.length>0&&(current=stack.pop()),current==grid[0]){console.log("maze created"),current.highlightPlayer(0,255,0);break}}strokeWeight(lineWeight),stroke(0),line(0,0,0,height),line(0,height,width,height),line(width,height,width,0),line(width,0,0,0),successSound&&adjustGoalSound(),document.getElementById("level").innerHTML=`Level: ${level}`}function keyPressed(){if(canPlay()&&!isMobile&&nextLevelSound.paused&&!spacePlayAgain)if(track.connect(panner).connect(audioContext.destination),panner.positionX.value=originalPos.x,panner.positionY.value=originalPos.y,panner.positionZ.value=originalPos.z,keyCode==UP_ARROW)moveUp();else if(keyCode==RIGHT_ARROW)moveRight();else if(keyCode==DOWN_ARROW)moveDown();else if(keyCode==LEFT_ARROW)moveLeft();else{if(keyCode==ENTER)return console.log("enter"),void createNewMaze();keyCode==SHIFT&&(console.log("shift: previous level"),previousLevel())}}function index(e,n){return e<0||n<0||e>cols-1||n>rows-1?-1:e+n*cols}function Cell(e,n){this.i=e,this.j=n,this.walls=[!0,!0,!0,!0],this.visited=!1,this.checkNeighbors=function(){var o=[],t=grid[index(e,n-1)],i=grid[index(e+1,n)],a=grid[index(e,n+1)],l=grid[index(e-1,n)];return t&&!t.visited&&o.push(t),i&&!i.visited&&o.push(i),a&&!a.visited&&o.push(a),l&&!l.visited&&o.push(l),o.length>0?o[floor(random(0,o.length))]:void 0},this.show=function(){var e=this.i*w,n=this.j*w;strokeWeight(lineWeight),stroke(0),this.walls[0]&&line(e,n,e+w,n),this.walls[1]&&line(e+w,n,e+w,n+w),this.walls[2]&&line(e+w,n+w,e,n+w),this.walls[3]&&line(e,n+w,e,n),this.visited&&(noStroke(),erase(),fill(0,0,0),rect(e+lineWeight/2,n+lineWeight/2,w,w),noErase(),fill(75,156,211),rect(e+lineWeight/2,n+lineWeight/2,w,w),lastCol=Math.sqrt(grid.length)-1,noStroke(),fill(51,153,51),image(imgSit,lastCol*w+lineWeight/2,randRow*w+lineWeight/2,w,w-lineWeight))},this.fillAfterErase=function(e,n,o){var t=this.i*w,i=this.j*w;noStroke(),fill(e,n,o),rect(t+w/8,i+w/8,3*w/4,3*w/4)},this.mazeCleared=function(){if(isFinalRowCol())if(console.log("same level: different maze"),nextLevelSound.pause(),nextLevelSound.currentTime=0,nextLevelSound.play(),profIdx=++profIdx>11?0:profIdx,4===level&&counter%3==0){document.getElementById("play-again").style.visibility="visible";let e=new SpeechSynthesisUtterance("You win! The professors are home... Press the space bar to play again.");synth.speak(e),spacePlayAgain=!0}else nextLevel();console.log("entered maze cleared function")},this.highlightPlayer=function(e,n,o,t){var i=this.i*w,a=this.j*w;noStroke(),fill(e,n,o),t?rect(i+w/6,a+w/6,w/1.5,w/1.5):image(imgs[0],i+w/4,a+w/4,w/2,w/2)}}function getCurrRow(){return floor(currCellLoc/cols)}function getCurrCol(){return currCellLoc-cols*getCurrRow()}function isFinalRowCol(){return getCurrRow()===randRow&&getCurrCol()===lastCol}function removeWalls(e,n){var o=e.i-n.i;1===o?(e.walls[3]=!1,n.walls[1]=!1):-1===o&&(e.walls[1]=!1,n.walls[3]=!1);var t=e.j-n.j;1===t?(e.walls[0]=!1,n.walls[2]=!1):-1===t&&(e.walls[2]=!1,n.walls[0]=!1)}function randomNumber(e,n){return e=Math.ceil(e),n=Math.floor(n),Math.floor(Math.random()*(n-e+1))+e}function moveUp(){if(!nextLevelSound.paused||spacePlayAgain)return;let e;var n;(isMobile||(track.connect(panner).connect(audioContext.destination),panner.positionX.value=originalPos.x,panner.positionY.value=originalPos.y,panner.positionZ.value=originalPos.z),console.log("up"),current.walls[0])?(console.log("hit a wall..."),isMobile?mobileFailSound.play():(panner.positionY.value+=5e3,failSound.play())):(console.log("SUCCESS!"),e=grid[currCellLoc-=cols],stopAndPlaySound(),(n=document.getElementById("upArrow"))&&n.focus());(n=document.getElementById("upArrow"))&&(n.style.backgroundColor="green",setTimeout(function(){n.style.backgroundColor="#4B9CD3"},200)),movePlayer(e)}function moveDown(){if(!nextLevelSound.paused||spacePlayAgain)return;let e;var n;(isMobile||(track.connect(panner).connect(audioContext.destination),panner.positionX.value=originalPos.x,panner.positionY.value=originalPos.y,panner.positionZ.value=originalPos.z),console.log("down"),console.log("down"),current.walls[2])?(console.log("hit a wall..."),isMobile?mobileFailSound.play():(panner.positionY.value-=5e3,failSound.play())):(console.log("SUCCESS!"),e=grid[currCellLoc+=cols],stopAndPlaySound(),(n=document.getElementById("downArrow"))&&n.focus());(n=document.getElementById("downArrow"))&&(n.style.backgroundColor="green",setTimeout(function(){n.style.backgroundColor="#4B9CD3"},200)),movePlayer(e)}function moveLeft(){if(!nextLevelSound.paused||spacePlayAgain)return;let e;var n;(isMobile||(track.connect(panner).connect(audioContext.destination),panner.positionX.value=originalPos.x,panner.positionY.value=originalPos.y,panner.positionZ.value=originalPos.z),console.log("left"),current.walls[3])?(console.log("hit a wall..."),isMobile?mobileFailSound.play():(panner.positionX.value-=5e3,failSound.play())):(console.log("SUCCESS!"),e=grid[currCellLoc-=1],stopAndPlaySound(),(n=document.getElementById("leftArrow"))&&n.focus());(n=document.getElementById("leftArrow"))&&(n.style.backgroundColor="green",setTimeout(function(){n.style.backgroundColor="#4B9CD3"},200)),movePlayer(e)}function moveRight(){if(!nextLevelSound.paused||spacePlayAgain)return;let e;var n;(isMobile||(track.connect(panner).connect(audioContext.destination),panner.positionX.value=originalPos.x,panner.positionY.value=originalPos.y,panner.positionZ.value=originalPos.z),console.log("right"),current.walls[1])?(console.log("hit a wall..."),isMobile?mobileFailSound.play():(panner.positionX.value+=5e3,failSound.play())):(console.log("SUCCESS!"),e=grid[currCellLoc+=1],stopAndPlaySound(),(n=document.getElementById("rightArrow"))&&n.focus());(n=document.getElementById("rightArrow"))&&(n.style.backgroundColor="green",setTimeout(function(){n.style.backgroundColor="#4B9CD3"},200)),movePlayer(e)}function movePlayer(e){void 0!==e&&(erase(),current.highlightPlayer(0,0,0,!0),noErase(),current.fillAfterErase(75,156,211),(current=e).highlightPlayer(0,255,0,!1),current.mazeCleared(),adjustGoalSound())}function stopAndPlaySound(){isFinalRowCol()||(successSound.pause(),successSound.currentTime=0,successSound.play())}function adjustGoalSound(){let e=.25;e*=2;let n=abs(randRow-getCurrRow())+abs(lastCol-getCurrCol()),o=rows+cols-2,t=Math.pow(2,o-n)/Math.pow(2,o);t*=.5,console.log("plaisted volume: "+t),isMobile||(document.getElementById("ambient").volume=t)}function createSound(){const e=window.AudioContext||window.webkitAudioContext;if(audioContext=new e,isMobile);else{track=audioContext.createMediaElementSource(failSound),trackAmbient=audioContext.createMediaElementSource(ambientSound);let e=audioContext.listener;const n=window.innerWidth/2,o=window.innerHeight/2,t=300;originalPos={x:n,y:o,z:t-5},e.forwardX.value=0,e.forwardY.value=0,e.upZ.value=0,e.positionX.value=originalPos.x,e.positionY.value=originalPos.y,e.positionZ.value=originalPos.z;const i="HRTF",a="linear",l=1e4,r=1,s=10,c=n,u=o,d=t,g=0,v=0,p=-1;panner=new PannerNode(audioContext,{panningModel:i,distanceModel:a,positionX:c,positionY:u,positionZ:d,orientationX:g,orientationY:v,orientationZ:p,refDistance:r,maxDistance:l,rolloffFactor:s,coneInnerAngle:60,coneOuterAngle:90,coneOuterGain:.3});pannerAmbient=new PannerNode(audioContext,{panningModel:i,distanceModel:a,positionX:c,positionY:u,positionZ:d,orientationX:g,orientationY:v,orientationZ:p,refDistance:r,maxDistance:l,rolloffFactor:s,coneInnerAngle:30,coneOuterAngle:45,coneOuterGain:.15}),ambientOriginalPos=ambientCurrPos={x:n,y:o,z:t-5+9e3},trackAmbient.connect(pannerAmbient).connect(audioContext.destination),ambientSound.play(),document.getElementById("ambient").loop=!0,adjustGoalSound()}}function loadGame(){loaded&&(synth.cancel(),checkCanvasScreenSize(),(canvas=createCanvas(canvasSize,canvasSize)).position(canvasPosX,canvasPosY),document.getElementById("intro").style.display="none",document.getElementById("startGameBtn").style.display="none",document.getElementById("buttons").style.display="block",createNewMaze(),createSound())}function checkCanvasScreenSize(){let e=canvasSize;return window.innerWidth<1250?(w=240/level,canvasSize=480,canvasPosX=5,canvasPosY=100):(w=280/level,canvasSize=560,canvasPosX=50,canvasPosY=100),e==canvasSize}function canPlay(){return"none"==document.getElementById("intro").style.display}function detectMobileBrowser(){return navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/iPod/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i)}nextLevelSound.addEventListener("ended",function(){if(!spacePlayAgain){nextLevelSound.currentTime=0,console.log("ended"),createNewMaze();let e=new SpeechSynthesisUtterance("Level "+level);synth.speak(e)}});var loaded=!1;window.addEventListener("load",function(){var e=setInterval(function(){document.getElementById("defaultCanvas0")&&(clearInterval(e),loaded=!0);console.log("hello")},100);document.getElementById("level").innerHTML=`Level: ${level}`}),document.documentElement.addEventListener("mousedown",function(){window.Tone&&"running"!==window.Tone.context.state&&Tone.context.resume()});var spaceLoad=!1,spacePlayAgain=!1;document.body.onkeyup=function(e){if(32==e.keyCode)if(spaceLoad){if(spacePlayAgain){level=1,counter=1,synth.cancel();let e=new SpeechSynthesisUtterance("Level "+level);synth.speak(e),createNewMaze(),spacePlayAgain=!1}}else{spaceLoad=!0;let e=new SpeechSynthesisUtterance("Level one");synth.speak(e),loadGame()}else if(9==e.keyCode&&!spaceLoad){synth.speaking&&synth.cancel();let e=new SpeechSynthesisUtterance(document.getElementById("intro").textContent);synth.speak(e)}};